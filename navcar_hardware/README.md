# NavCar Hardware Interface

这个包实现了NavCar机器人的ROS2 hardware interface，通过TCP通信与硬件控制器进行交互。

## 功能特性

- TCP服务器监听硬件连接 (默认端口3011)
- 自动处理网络连接和断线重连
- 支持两轮差动驱动控制
- 实时状态反馈和命令发送
- MODBUS RTU CRC16校验

## 通信协议

### 状态上报 (从硬件接收)
- 帧头: 0x55AA
- 命令: 0x02
- 包含左右电机转速和位置信息
- 单位: 转速(0.001rpm), 位置(0.001度)

### 运动控制 (发送到硬件)
- 帧头: 0x55AA  
- 命令: 0x01
- 包含左右电机转速命令
- 单位: 转速(0.001rpm)

## 配置参数

在URDF中可以配置以下参数:
- `tcp_host`: TCP服务器监听地址 (默认: "0.0.0.0")
- `tcp_port`: TCP服务器监听端口 (默认: 3011)
- `wheel_radius`: 车轮半径，用于单位转换 (默认: 0.16m)

## 使用方法

1. 编译包:
```bash
colcon build --packages-select navcar_hardware
```

2. 测试硬件接口:
```bash
ros2 launch navcar_hardware test_hardware.launch.py use_mock_hardware:=false
```

3. 发送速度命令:
```bash
ros2 topic pub /mobile_base_controller/cmd_vel geometry_msgs/msg/Twist "{linear: {x: 0.1}, angular: {z: 0.0}}"
```

## 故障排除

- 检查TCP端口是否被占用
- 确认硬件客户端能连接到服务器
- 查看日志输出了解连接状态
- 验证CRC校验是否正确

## 依赖项

- hardware_interface
- pluginlib  
- rclcpp
- rclcpp_lifecycle

## 生成该包使用的 AI 提示词

我需要完成ROS2 control 中 hardware component 的代码，请添加包 navcar_hardware 来实现。我的硬件只有两个使用转速方式控制的轮子，其通信接口为TCP，硬件是客户端，所以我需要写服务端，其监听地点0.0.0.0，端口号3011，接收连接后按照以下协议读取：

| 字段          | 功能    | 数据类型  | 字节数 | 字节偏移 | 备注                        |
|-------------|-------|-------|-----|------|---------------------------|
| HEAD        | 帧头    | U16   | 2   | 0    | 固定为0x55AA                 |
| LEN         | 帧长    | U16   | 2   | 2    | 单位为字节，整个帧的长度，不同命令的帧长不同    |
| CMD         | 命令    | U8    | 1   | 4    | 0x02表示状态上报                |
| MOTOR_LEFT  | 左电机转速 | INT32 | 4   | 5    | 单位为0.001rpm，向前时应为正        |
| MOTOR_RIGHT | 右电机转速 | INT32 | 4   | 9    | 单位为0.001rpm，向前时应为正        |
| POS_LEFT    | 左电机里程 | INT32 | 4   | 13   | 单位为0.001度                 |
| POS_RIGHT   | 右电机里程 | INT32 | 4   | 17   | 单位为0.001度                 |
| CRC16       | 校验    | U16   | 2   | 21   | 不包括帧头和自身,采用 MODBUS RTU 算法 |

读取的内容在进行单位转换等处理后放置到相应的成员变量中，然后发送命令时同样需要进行单位转换等，然后通过以下协议发送到硬件：

| 字段        | 功能           | 数据类型 | 字节数 | 字节偏移 | 备注                                         |
| ----------- | -------------- | -------- | ------ | -------- | -------------------------------------------- |
| HEAD        | 帧头           | U16      | 2      | 0        | 固定为0x55AA                                 |
| LEN         | 帧长           | U16      | 2      | 2        | 单位为字节，整个帧的长度，不同命令的帧长不同 |
| CMD         | 命令           | U8       | 1      | 4        | 0x01表示运动控制                             |
| MOTOR_LEFT  | 左电机转速     | INT32    | 4      | 5        | 单位为0.001rpm,向前时应为正                  |
| MOTOR_RIGHT | 右电机转速     | INT32    | 4      | 9        | 单位为0.001rpm,向前时应为正                  |
| RESET_ODOM  | 是否复位里程计 | U8       | 1      | 13       | 0: 不复位，1: 复位                           |
| CRC16       | 校验           | U16      | 2      | 14       | 不包括帧头和自身,采用 MODBUS RTU 算法        |

协议字节序均为大端。需要支持异常处理，网络断开时自动重连，并打印相关日志。